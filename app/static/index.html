<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <title>éŠæˆ²é…å°ç¶²</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --p:#2563eb; --bg:#f6f7fb; --card:#fff; --mut:#666; }
    body{margin:0;background:var(--bg);font-family:ui-sans-serif,system-ui;}
    .wrap{max-width:1100px;margin:28px auto;padding:0 16px}
    h1{margin:0 0 20px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .card{background:var(--card);border-radius:14px;padding:16px;box-shadow:0 2px 10px rgba(0,0,0,.06)}
    label{display:block;margin:8px 0 6px;color:#111}
    input,select,textarea{width:100%;padding:10px;border:1px solid #ddd;border-radius:10px;font-size:14px}
    textarea{min-height:80px}
    .btn{display:inline-block;background:var(--p);color:#fff;border:none;border-radius:10px;padding:10px 14px;cursor:pointer}
    .btn.muted{background:#e2e8f0;color:#111}
    .muted{color:var(--mut);font-size:12px}
    .list{display:grid;grid-template-columns:1fr;gap:8px;margin-top:10px}
    .pill{display:inline-block;background:#eef2ff;color:#3730a3;border-radius:999px;padding:2px 8px;margin-right:4px;font-size:12px}
    .item{border:1px solid #eee;border-radius:12px;padding:12px}
    .item h4{margin:0 0 6px}
    .flex{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .right{margin-left:auto}
    .chat{height:320px;overflow:auto;background:#fafafa;border:1px solid #eee;border-radius:10px;padding:10px}
    .msg{margin:4px 0;padding:6px 10px;border-radius:10px;max-width:70%}
    .mine{background:#dbeafe;margin-left:auto}
    .theirs{background:#f1f5f9}
  </style>
</head>
<body>
<div class="wrap">

  <h1>ğŸ® éŠæˆ²é…å°ç¶²</h1>

  <div class="row">
    <!-- Auth -->
    <div class="card">
      <h3>ç™»å…¥ / è¨»å†Š</h3>
      <div class="flex">
        <input id="authUser" placeholder="ä½¿ç”¨è€…åç¨±" style="max-width:200px">
        <input id="authPass" placeholder="å¯†ç¢¼" type="password" style="max-width:200px">
        <button class="btn" id="btnLogin">ç™»å…¥</button>
        <button class="btn muted" id="btnSignup">è¨»å†Š</button>
        <span class="muted" id="authHint"></span>
      </div>
      <div class="muted" style="margin-top:6px">Tokenï¼š<span id="tokenSpan">ï¼ˆæœªç™»å…¥ï¼‰</span></div>
    </div>

    <!-- Profile -->
    <div class="card">
      <h3>æˆ‘çš„å€‹äººæª”æ¡ˆ</h3>
      <div class="flex" style="gap:10px">
        <button class="btn muted" id="btnFetchMe">è®€å–</button>
        <button class="btn" id="btnSaveMe">å„²å­˜</button>
        <span class="muted" id="saveHint"></span>
      </div>
      <label>æš±ç¨±</label>
      <input id="displayName" placeholder="æš±ç¨±">
      <label>æ€§åˆ¥</label>
      <select id="gender">
        <option value="">ä¸å…¬é–‹</option>
        <option value="ç”·">ç”·</option>
        <option value="å¥³">å¥³</option>
        <option value="å…¶ä»–">å…¶ä»–</option>
      </select>
      <label>ç”Ÿæ—¥</label>
      <input id="birthday" type="date">
      <label>åŸå¸‚</label>
      <input id="city" placeholder="åŸå¸‚">
      <label>è‡ªä»‹</label>
      <textarea id="bio" placeholder="ç°¡çŸ­è‡ªæˆ‘ä»‹ç´¹"></textarea>
      <label>èˆˆè¶£æ¨™ç±¤ï¼ˆé€—è™Ÿåˆ†éš”ï¼Œè‹±æ–‡è‡ªå‹•å¤§å¯«ï¼›ä¸­æ–‡åŸæ¨£ï¼‰</label>
      <input id="interests" placeholder="LOL, VALORANT, ç™»å±±">
      <div class="flex" style="margin-top:10px">
        <button class="btn" id="btnGeo">å›å ±å®šä½</button>
        <span class="muted" id="geoHint"></span>
      </div>
    </div>
  </div>

  <div class="row" style="margin-top:16px">
    <!-- Nearby -->
    <div class="card">
      <h3>é™„è¿‘ï¼ˆç¯©é¸ï¼‰</h3>
      <div class="flex">
        <select id="qGender" style="max-width:120px">
          <option value="">æ€§åˆ¥ä¸é™</option>
          <option value="ç”·">ç”·</option>
          <option value="å¥³">å¥³</option>
          <option value="å…¶ä»–">å…¶ä»–</option>
        </select>
        <input id="qMin" type="number" placeholder="æœ€å°å¹´é½¡" style="max-width:120px">
        <input id="qMax" type="number" placeholder="æœ€å¤§å¹´é½¡" style="max-width:120px">
        <input id="qInterest" placeholder="èˆˆè¶£é—œéµå­—" style="max-width:180px">
        <input id="qRadius" type="number" value="100" style="max-width:100px">
        <button class="btn" id="btnSearch">æœå°‹</button>
        <span class="muted">ï¼ˆåŠå¾‘ kmï¼Œé è¨­ 100ï¼‰</span>
      </div>
      <div class="list" id="nearbyList"></div>
      <div class="flex" style="margin-top:10px">
        <button class="btn" id="btnPair">å°å‹¾é¸çš„äººæŒ‰è®š</button>
        <span class="muted" id="pairHint"></span>
      </div>
    </div>

    <!-- Matches / Chat -->
    <div class="card">
      <div class="flex">
        <h3 style="margin:0">æˆ‘çš„é…å°</h3>
        <button class="btn muted right" id="btnReloadMatches">é‡æ–°æ•´ç†</button>
      </div>

      <div class="list" id="matchList"></div>

      <div id="chatPanel" style="display:none;margin-top:10px">
        <h4 id="chatTitle" style="margin:10px 0">èŠå¤©å®¤</h4>
        <div class="chat" id="chatBox"></div>
        <div class="flex" style="margin-top:8px">
          <input id="chatInput" placeholder="è¼¸å…¥è¨Šæ¯â€¦">
          <button class="btn" id="btnSend">é€å‡º</button>
        </div>
      </div>
    </div>
  </div>

</div>

<script>
const API = ''; // åŒæºéƒ¨ç½²ä¸‹å¯ç•™ç©º
const tokenSpan = document.getElementById('tokenSpan');
const authHint = document.getElementById('authHint');
const saveHint = document.getElementById('saveHint');
const geoHint = document.getElementById('geoHint');
const pairHint = document.getElementById('pairHint');

let TOKEN = localStorage.getItem('token') || '';

function setToken(t){
  TOKEN = t || '';
  localStorage.setItem('token', TOKEN);
  tokenSpan.textContent = TOKEN ? TOKEN.slice(0,20)+'...' : 'ï¼ˆæœªç™»å…¥ï¼‰';
}

setToken(TOKEN);

// ====== å·¥å…· ======
function canonGenderToAPI(v){
  if(!v) return null;
  if(v === 'ç”·') return 'male';
  if(v === 'å¥³') return 'female';
  if(v === 'å…¶ä»–') return 'other';
  return v; // male/female/other
}

function showToast(el, msg, ok=true){
  el.textContent = msg;
  el.style.color = ok ? '#059669' : '#b91c1c';
  setTimeout(()=> el.textContent='', 2500);
}

async function api(path, opt={}){
  const headers = opt.headers || {};
  if(TOKEN) headers['Authorization'] = 'Bearer ' + TOKEN;
  if(opt.json){
    headers['Content-Type'] = 'application/json';
    opt.body = JSON.stringify(opt.json);
  }
  const res = await fetch(API + path, {...opt, headers});
  if(!res.ok){
    const t = await res.text().catch(()=> '');
    throw new Error(res.status + ' ' + res.statusText + ' ' + t);
  }
  const ct = res.headers.get('content-type') || '';
  return ct.includes('application/json') ? res.json() : res.text();
}

// ====== Auth ======
document.getElementById('btnLogin').onclick = async () => {
  const username = document.getElementById('authUser').value.trim();
  const password = document.getElementById('authPass').value;
  if(!username || !password){ showToast(authHint, 'è«‹è¼¸å…¥å¸³å¯†', false); return; }
  try{
    const data = await api('/auth/login', {method:'POST', json:{username, password}});
    setToken(data.access_token);
    showToast(authHint, 'ç™»å…¥æˆåŠŸ');
  }catch(e){ showToast(authHint, e.message, false); }
};

document.getElementById('btnSignup').onclick = async () => {
  const username = document.getElementById('authUser').value.trim();
  const password = document.getElementById('authPass').value;
  if(!username || !password){ showToast(authHint, 'è«‹è¼¸å…¥å¸³å¯†', false); return; }
  try{
    await api('/auth/signup', {method:'POST', json:{username, password}});
    showToast(authHint, 'è¨»å†ŠæˆåŠŸï¼Œè«‹å†ç™»å…¥');
  }catch(e){ showToast(authHint, e.message, false); }
};

// ====== Profile ======
document.getElementById('btnFetchMe').onclick = async () => {
  try{
    const me = await api('/me', {method:'GET'});
    document.getElementById('displayName').value = me.display_name || '';
    document.getElementById('gender').value =
      me.gender === 'male' ? 'ç”·' : me.gender === 'female' ? 'å¥³' : (me.gender ? 'å…¶ä»–' : '');
    document.getElementById('birthday').value = me.birthday || '';
    document.getElementById('city').value = me.city || '';
    document.getElementById('bio').value = me.bio || '';
    document.getElementById('interests').value = (me.interests || []).join(', ');
    showToast(saveHint, 'å·²è®€å–');
  }catch(e){ showToast(saveHint, e.message, false); }
};

document.getElementById('btnSaveMe').onclick = async () => {
  const body = {
    display_name: document.getElementById('displayName').value.trim() || null,
    gender: canonGenderToAPI(document.getElementById('gender').value),
    birthday: document.getElementById('birthday').value || null,
    city: document.getElementById('city').value.trim() || null,
    bio: document.getElementById('bio').value.trim() || null,
    interests: document.getElementById('interests').value || null,
  };
  try{
    // æ­£å¼ç”¨ PUTï¼›å¾Œç«¯ä¹Ÿå…¼å®¹ POST /me
    await api('/me', {method:'PUT', json: body});
    showToast(saveHint, 'å·²å„²å­˜');
  }catch(e){ showToast(saveHint, e.message, false); }
};

// ====== å®šä½ï¼ˆæ‰‹å‹• + è‡ªå‹•ï¼‰ ======
async function reportGeo(lat,lng){
  try{
    await api('/me/location', {method:'POST', json:{lat, lng}});
    showToast(geoHint, 'å®šä½å·²å›å ±');
  }catch(e){ showToast(geoHint, e.message, false); }
}
document.getElementById('btnGeo').onclick = () => {
  if(!navigator.geolocation){ showToast(geoHint,'ç€è¦½å™¨ä¸æ”¯æ´å®šä½', false); return; }
  navigator.geolocation.getCurrentPosition(pos => {
    reportGeo(pos.coords.latitude, pos.coords.longitude);
  }, err => showToast(geoHint, 'å®šä½å¤±æ•—ï¼š' + err.message, false), {enableHighAccuracy:true,timeout:8000});
};
// è‡ªå‹•å›å ±ï¼ˆç™»å…¥å¾Œ 3 ç§’å˜—è©¦ä¸€æ¬¡ï¼‰
setTimeout(()=>{ if(TOKEN) document.getElementById('btnGeo').click(); }, 3000);

// ====== Nearby æœå°‹ + æŒ‰è®šé…å° ======
let lastNearby = [];
document.getElementById('btnSearch').onclick = async () => {
  const radius_km = Number(document.getElementById('qRadius').value || 100);
  const payload = {
    radius_km,
    gender: canonGenderToAPI(document.getElementById('qGender').value),
    min_age: document.getElementById('qMin').value || null,
    max_age: document.getElementById('qMax').value || null,
    interest: document.getElementById('qInterest').value || null,
  };
  try{
    const data = await api('/nearby', {method:'POST', json: payload});
    lastNearby = data.users || [];
    renderNearby();
  }catch(e){ alert(e.message); }
};

function renderNearby(){
  const box = document.getElementById('nearbyList');
  box.innerHTML = '';
  lastNearby.forEach(u=>{
    const div = document.createElement('div');
    div.className='item';
    div.innerHTML = `
      <div class="flex">
        <h4>${u.display_name || '@'+u.username}</h4>
        <span class="pill">${u.gender==='male'?'ç”·':u.gender==='female'?'å¥³':'å…¶ä»–'}</span>
        <span class="pill">${u.age ?? 'â€”'} æ­²</span>
        <span class="pill">${u.city || 'â€”'}</span>
        <span class="right muted">${u.distance_km} km</span>
      </div>
      <div class="muted" style="margin:6px 0">${u.bio || 'ï¼ˆå°šæœªæ’°å¯«è‡ªæˆ‘ä»‹ç´¹ï¼‰'}</div>
      <div>${(u.interests||[]).map(t=>`<span class="pill">${t}</span>`).join(' ')}</div>
      <div class="flex" style="margin-top:8px">
        <label class="flex"><input type="checkbox" data-id="${u.id}" ${u.liked?'checked':''}/> å‹¾é¸æŒ‰è®š</label>
        ${u.matched?'<span class="pill">å·²äº’è®š</span>':''}
      </div>
    `;
    box.appendChild(div);
  });
}

document.getElementById('btnPair').onclick = async () => {
  const ids = [...document.querySelectorAll('#nearbyList input[type=checkbox]:checked')].map(x=>Number(x.dataset.id));
  if(!ids.length){ showToast(pairHint, 'å°šæœªå‹¾é¸', false); return; }
  try{
    const rs = await api('/pair', {method:'POST', json:{target_ids: ids}});
    showToast(pairHint, `æˆåŠŸ ${rs.ok}ã€å¤±æ•— ${rs.fail}`);
    document.getElementById('btnReloadMatches').click();
  }catch(e){ showToast(pairHint, e.message, false); }
};

// ====== Matches + Chat ======
document.getElementById('btnReloadMatches').onclick = async () => {
  try{
    const data = await api('/matches', {method:'GET'});
    const box = document.getElementById('matchList');
    box.innerHTML = '';

    (data.matches||[]).forEach(u=>{
      const div = document.createElement('div');
      div.className = 'item';
      div.innerHTML = `
        <div class="flex">
          <h4>${u.display_name || '@'+u.username}</h4>
          <span class="pill">${u.gender==='male'?'ç”·':u.gender==='female'?'å¥³':'å…¶ä»–'}</span>
          <span class="pill">${u.age ?? 'â€”'} æ­²</span>
          <span class="pill">${u.city || 'â€”'}</span>
          <span class="right muted">${u.distance_km ?? 'â€”'} km</span>
        </div>
        <div class="muted" style="margin:6px 0">${u.bio || 'ï¼ˆå°šæœªæ’°å¯«è‡ªæˆ‘ä»‹ç´¹ï¼‰'}</div>
        <div>${(u.interests||[]).map(t=>`<span class="pill">${t}</span>`).join(' ')}</div>
        <div style="margin-top:8px"><button class="btn" data-chat="${u.id}">é–‹å•ŸèŠå¤©å®¤</button></div>
      `;
      box.appendChild(div);
    });

    box.querySelectorAll('button[data-chat]').forEach(btn=>{
      btn.onclick = () => openChat(Number(btn.dataset.chat));
    });
  }catch(e){ alert(e.message); }
};

let WS = null, PEER = null;
async function openChat(peerId){
  // æ‹‰æ­·å²
  const hist = await api(`/chat/history/${peerId}`, {method:'GET'});
  const panel = document.getElementById('chatPanel');
  const box = document.getElementById('chatBox');
  document.getElementById('chatTitle').textContent = `èŠå¤©å®¤ï¼ˆå°è±¡ #${peerId}ï¼‰`;
  box.innerHTML = '';
  hist.forEach(m=>pushMsg(m, m.sender_id===peerId?'theirs':'mine'));
  panel.style.display='block';

  // å»ºç«‹ WS
  if(WS) try{ WS.close(); }catch{}
  PEER = peerId;
  WS = new WebSocket(`${location.protocol==='https:'?'wss':'ws'}://${location.host}/ws/chat?token=${encodeURIComponent(TOKEN)}&peer_id=${peerId}`);
  WS.onmessage = (ev)=>{
    const data = JSON.parse(ev.data||'{}');
    if(data.type==='message'){
      pushMsg({content:data.content, sender_id:data.sender_id}, data.sender_id===peerId?'theirs':'mine');
    }
  };
}

function pushMsg(m, who){
  const box = document.getElementById('chatBox');
  const div = document.createElement('div');
  div.className = 'msg ' + (who==='mine'?'mine':'theirs');
  div.textContent = m.content;
  box.appendChild(div);
  box.scrollTop = box.scrollHeight;
}

document.getElementById('btnSend').onclick = () => {
  const ipt = document.getElementById('chatInput');
  const t = ipt.value.trim();
  if(!t || !WS || WS.readyState!==1) return;
  WS.send(t);
  ipt.value='';
};

// å•Ÿå‹•é è¨­ï¼šå˜—è©¦è¼‰å…¥è‡ªå·±èˆ‡é…å°æ¸…å–®
if(TOKEN){
  document.getElementById('btnFetchMe').click();
  document.getElementById('btnReloadMatches').click();
  document.getElementById('btnSearch').click();
}
</script>
</body>
</html>
