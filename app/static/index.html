<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <title>遊戲配對網</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --p:#2563eb; --bg:#f6f7fb; --card:#fff; --mut:#666; }
    body{margin:0;background:var(--bg);font-family:ui-sans-serif,system-ui;}
    .wrap{max-width:1100px;margin:28px auto;padding:0 16px}
    h1{margin:0 0 20px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .card{background:var(--card);border-radius:14px;padding:16px;box-shadow:0 2px 10px rgba(0,0,0,.06)}
    label{display:block;margin:8px 0 6px;color:#111}
    input,select,textarea{width:100%;padding:10px;border:1px solid #ddd;border-radius:10px;font-size:14px}
    textarea{min-height:80px}
    .btn{display:inline-block;background:var(--p);color:#fff;border:none;border-radius:10px;padding:10px 14px;cursor:pointer}
    .btn.muted{background:#e2e8f0;color:#111}
    .muted{color:var(--mut);font-size:12px}
    .list{display:grid;grid-template-columns:1fr;gap:8px;margin-top:10px}
    .pill{display:inline-block;background:#eef2ff;color:#3730a3;border-radius:999px;padding:2px 8px;margin-right:4px;font-size:12px}
    .item{border:1px solid #eee;border-radius:12px;padding:12px}
    .item h4{margin:0 0 6px}
    .flex{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .right{margin-left:auto}
    .chat{height:320px;overflow:auto;background:#fafafa;border:1px solid #eee;border-radius:10px;padding:10px}
    .msg{margin:4px 0;padding:6px 10px;border-radius:10px;max-width:70%}
    .mine{background:#dbeafe;margin-left:auto}
    .theirs{background:#f1f5f9}
  </style>
</head>
<body>
<div class="wrap">

  <h1>🎮 遊戲配對網</h1>

  <div class="row">
    <!-- Auth -->
    <div class="card">
      <h3>登入 / 註冊</h3>
      <div class="flex">
        <input id="authUser" placeholder="使用者名稱" style="max-width:200px">
        <input id="authPass" placeholder="密碼" type="password" style="max-width:200px">
        <button class="btn" id="btnLogin">登入</button>
        <button class="btn muted" id="btnSignup">註冊</button>
        <span class="muted" id="authHint"></span>
      </div>
      <div class="muted" style="margin-top:6px">Token：<span id="tokenSpan">（未登入）</span></div>
    </div>

    <!-- Profile -->
    <div class="card">
      <h3>我的個人檔案</h3>
      <div class="flex" style="gap:10px">
        <button class="btn muted" id="btnFetchMe">讀取</button>
        <button class="btn" id="btnSaveMe">儲存</button>
        <span class="muted" id="saveHint"></span>
      </div>
      <label>暱稱</label>
      <input id="displayName" placeholder="暱稱">
      <label>性別</label>
      <select id="gender">
        <option value="">不公開</option>
        <option value="男">男</option>
        <option value="女">女</option>
        <option value="其他">其他</option>
      </select>
      <label>生日</label>
      <input id="birthday" type="date">
      <label>城市</label>
      <input id="city" placeholder="城市">
      <label>自介</label>
      <textarea id="bio" placeholder="簡短自我介紹"></textarea>
      <label>興趣標籤（逗號分隔，英文自動大寫；中文原樣）</label>
      <input id="interests" placeholder="LOL, VALORANT, 登山">
      <div class="flex" style="margin-top:10px">
        <button class="btn" id="btnGeo">回報定位</button>
        <span class="muted" id="geoHint"></span>
      </div>
    </div>
  </div>

  <div class="row" style="margin-top:16px">
    <!-- Nearby -->
    <div class="card">
      <h3>附近（篩選）</h3>
      <div class="flex">
        <select id="qGender" style="max-width:120px">
          <option value="">性別不限</option>
          <option value="男">男</option>
          <option value="女">女</option>
          <option value="其他">其他</option>
        </select>
        <input id="qMin" type="number" placeholder="最小年齡" style="max-width:120px">
        <input id="qMax" type="number" placeholder="最大年齡" style="max-width:120px">
        <input id="qInterest" placeholder="興趣關鍵字" style="max-width:180px">
        <input id="qRadius" type="number" value="100" style="max-width:100px">
        <button class="btn" id="btnSearch">搜尋</button>
        <span class="muted">（半徑 km，預設 100）</span>
      </div>
      <div class="list" id="nearbyList"></div>
      <div class="flex" style="margin-top:10px">
        <button class="btn" id="btnPair">對勾選的人按讚</button>
        <span class="muted" id="pairHint"></span>
      </div>
    </div>

    <!-- Matches / Chat -->
    <div class="card">
      <div class="flex">
        <h3 style="margin:0">我的配對</h3>
        <button class="btn muted right" id="btnReloadMatches">重新整理</button>
      </div>

      <div class="list" id="matchList"></div>

      <div id="chatPanel" style="display:none;margin-top:10px">
        <h4 id="chatTitle" style="margin:10px 0">聊天室</h4>
        <div class="chat" id="chatBox"></div>
        <div class="flex" style="margin-top:8px">
          <input id="chatInput" placeholder="輸入訊息…">
          <button class="btn" id="btnSend">送出</button>
        </div>
      </div>
    </div>
  </div>

</div>

<script>
const API = ''; // 同源部署下可留空
const tokenSpan = document.getElementById('tokenSpan');
const authHint = document.getElementById('authHint');
const saveHint = document.getElementById('saveHint');
const geoHint = document.getElementById('geoHint');
const pairHint = document.getElementById('pairHint');

let TOKEN = localStorage.getItem('token') || '';

function setToken(t){
  TOKEN = t || '';
  localStorage.setItem('token', TOKEN);
  tokenSpan.textContent = TOKEN ? TOKEN.slice(0,20)+'...' : '（未登入）';
}

setToken(TOKEN);

// ====== 工具 ======
function canonGenderToAPI(v){
  if(!v) return null;
  if(v === '男') return 'male';
  if(v === '女') return 'female';
  if(v === '其他') return 'other';
  return v; // male/female/other
}

function showToast(el, msg, ok=true){
  el.textContent = msg;
  el.style.color = ok ? '#059669' : '#b91c1c';
  setTimeout(()=> el.textContent='', 2500);
}

async function api(path, opt={}){
  const headers = opt.headers || {};
  if(TOKEN) headers['Authorization'] = 'Bearer ' + TOKEN;
  if(opt.json){
    headers['Content-Type'] = 'application/json';
    opt.body = JSON.stringify(opt.json);
  }
  const res = await fetch(API + path, {...opt, headers});
  if(!res.ok){
    const t = await res.text().catch(()=> '');
    throw new Error(res.status + ' ' + res.statusText + ' ' + t);
  }
  const ct = res.headers.get('content-type') || '';
  return ct.includes('application/json') ? res.json() : res.text();
}

// ====== Auth ======
document.getElementById('btnLogin').onclick = async () => {
  const username = document.getElementById('authUser').value.trim();
  const password = document.getElementById('authPass').value;
  if(!username || !password){ showToast(authHint, '請輸入帳密', false); return; }
  try{
    const data = await api('/auth/login', {method:'POST', json:{username, password}});
    setToken(data.access_token);
    showToast(authHint, '登入成功');
  }catch(e){ showToast(authHint, e.message, false); }
};

document.getElementById('btnSignup').onclick = async () => {
  const username = document.getElementById('authUser').value.trim();
  const password = document.getElementById('authPass').value;
  if(!username || !password){ showToast(authHint, '請輸入帳密', false); return; }
  try{
    await api('/auth/signup', {method:'POST', json:{username, password}});
    showToast(authHint, '註冊成功，請再登入');
  }catch(e){ showToast(authHint, e.message, false); }
};

// ====== Profile ======
document.getElementById('btnFetchMe').onclick = async () => {
  try{
    const me = await api('/me', {method:'GET'});
    document.getElementById('displayName').value = me.display_name || '';
    document.getElementById('gender').value =
      me.gender === 'male' ? '男' : me.gender === 'female' ? '女' : (me.gender ? '其他' : '');
    document.getElementById('birthday').value = me.birthday || '';
    document.getElementById('city').value = me.city || '';
    document.getElementById('bio').value = me.bio || '';
    document.getElementById('interests').value = (me.interests || []).join(', ');
    showToast(saveHint, '已讀取');
  }catch(e){ showToast(saveHint, e.message, false); }
};

document.getElementById('btnSaveMe').onclick = async () => {
  const body = {
    display_name: document.getElementById('displayName').value.trim() || null,
    gender: canonGenderToAPI(document.getElementById('gender').value),
    birthday: document.getElementById('birthday').value || null,
    city: document.getElementById('city').value.trim() || null,
    bio: document.getElementById('bio').value.trim() || null,
    interests: document.getElementById('interests').value || null,
  };
  try{
    // 正式用 PUT；後端也兼容 POST /me
    await api('/me', {method:'PUT', json: body});
    showToast(saveHint, '已儲存');
  }catch(e){ showToast(saveHint, e.message, false); }
};

// ====== 定位（手動 + 自動） ======
async function reportGeo(lat,lng){
  try{
    await api('/me/location', {method:'POST', json:{lat, lng}});
    showToast(geoHint, '定位已回報');
  }catch(e){ showToast(geoHint, e.message, false); }
}
document.getElementById('btnGeo').onclick = () => {
  if(!navigator.geolocation){ showToast(geoHint,'瀏覽器不支援定位', false); return; }
  navigator.geolocation.getCurrentPosition(pos => {
    reportGeo(pos.coords.latitude, pos.coords.longitude);
  }, err => showToast(geoHint, '定位失敗：' + err.message, false), {enableHighAccuracy:true,timeout:8000});
};
// 自動回報（登入後 3 秒嘗試一次）
setTimeout(()=>{ if(TOKEN) document.getElementById('btnGeo').click(); }, 3000);

// ====== Nearby 搜尋 + 按讚配對 ======
let lastNearby = [];
document.getElementById('btnSearch').onclick = async () => {
  const radius_km = Number(document.getElementById('qRadius').value || 100);
  const payload = {
    radius_km,
    gender: canonGenderToAPI(document.getElementById('qGender').value),
    min_age: document.getElementById('qMin').value || null,
    max_age: document.getElementById('qMax').value || null,
    interest: document.getElementById('qInterest').value || null,
  };
  try{
    const data = await api('/nearby', {method:'POST', json: payload});
    lastNearby = data.users || [];
    renderNearby();
  }catch(e){ alert(e.message); }
};

function renderNearby(){
  const box = document.getElementById('nearbyList');
  box.innerHTML = '';
  lastNearby.forEach(u=>{
    const div = document.createElement('div');
    div.className='item';
    div.innerHTML = `
      <div class="flex">
        <h4>${u.display_name || '@'+u.username}</h4>
        <span class="pill">${u.gender==='male'?'男':u.gender==='female'?'女':'其他'}</span>
        <span class="pill">${u.age ?? '—'} 歲</span>
        <span class="pill">${u.city || '—'}</span>
        <span class="right muted">${u.distance_km} km</span>
      </div>
      <div class="muted" style="margin:6px 0">${u.bio || '（尚未撰寫自我介紹）'}</div>
      <div>${(u.interests||[]).map(t=>`<span class="pill">${t}</span>`).join(' ')}</div>
      <div class="flex" style="margin-top:8px">
        <label class="flex"><input type="checkbox" data-id="${u.id}" ${u.liked?'checked':''}/> 勾選按讚</label>
        ${u.matched?'<span class="pill">已互讚</span>':''}
      </div>
    `;
    box.appendChild(div);
  });
}

document.getElementById('btnPair').onclick = async () => {
  const ids = [...document.querySelectorAll('#nearbyList input[type=checkbox]:checked')].map(x=>Number(x.dataset.id));
  if(!ids.length){ showToast(pairHint, '尚未勾選', false); return; }
  try{
    const rs = await api('/pair', {method:'POST', json:{target_ids: ids}});
    showToast(pairHint, `成功 ${rs.ok}、失敗 ${rs.fail}`);
    document.getElementById('btnReloadMatches').click();
  }catch(e){ showToast(pairHint, e.message, false); }
};

// ====== Matches + Chat ======
document.getElementById('btnReloadMatches').onclick = async () => {
  try{
    const data = await api('/matches', {method:'GET'});
    const box = document.getElementById('matchList');
    box.innerHTML = '';

    (data.matches||[]).forEach(u=>{
      const div = document.createElement('div');
      div.className = 'item';
      div.innerHTML = `
        <div class="flex">
          <h4>${u.display_name || '@'+u.username}</h4>
          <span class="pill">${u.gender==='male'?'男':u.gender==='female'?'女':'其他'}</span>
          <span class="pill">${u.age ?? '—'} 歲</span>
          <span class="pill">${u.city || '—'}</span>
          <span class="right muted">${u.distance_km ?? '—'} km</span>
        </div>
        <div class="muted" style="margin:6px 0">${u.bio || '（尚未撰寫自我介紹）'}</div>
        <div>${(u.interests||[]).map(t=>`<span class="pill">${t}</span>`).join(' ')}</div>
        <div style="margin-top:8px"><button class="btn" data-chat="${u.id}">開啟聊天室</button></div>
      `;
      box.appendChild(div);
    });

    box.querySelectorAll('button[data-chat]').forEach(btn=>{
      btn.onclick = () => openChat(Number(btn.dataset.chat));
    });
  }catch(e){ alert(e.message); }
};

let WS = null, PEER = null;
async function openChat(peerId){
  // 拉歷史
  const hist = await api(`/chat/history/${peerId}`, {method:'GET'});
  const panel = document.getElementById('chatPanel');
  const box = document.getElementById('chatBox');
  document.getElementById('chatTitle').textContent = `聊天室（對象 #${peerId}）`;
  box.innerHTML = '';
  hist.forEach(m=>pushMsg(m, m.sender_id===peerId?'theirs':'mine'));
  panel.style.display='block';

  // 建立 WS
  if(WS) try{ WS.close(); }catch{}
  PEER = peerId;
  WS = new WebSocket(`${location.protocol==='https:'?'wss':'ws'}://${location.host}/ws/chat?token=${encodeURIComponent(TOKEN)}&peer_id=${peerId}`);
  WS.onmessage = (ev)=>{
    const data = JSON.parse(ev.data||'{}');
    if(data.type==='message'){
      pushMsg({content:data.content, sender_id:data.sender_id}, data.sender_id===peerId?'theirs':'mine');
    }
  };
}

function pushMsg(m, who){
  const box = document.getElementById('chatBox');
  const div = document.createElement('div');
  div.className = 'msg ' + (who==='mine'?'mine':'theirs');
  div.textContent = m.content;
  box.appendChild(div);
  box.scrollTop = box.scrollHeight;
}

document.getElementById('btnSend').onclick = () => {
  const ipt = document.getElementById('chatInput');
  const t = ipt.value.trim();
  if(!t || !WS || WS.readyState!==1) return;
  WS.send(t);
  ipt.value='';
};

// 啟動預設：嘗試載入自己與配對清單
if(TOKEN){
  document.getElementById('btnFetchMe').click();
  document.getElementById('btnReloadMatches').click();
  document.getElementById('btnSearch').click();
}
</script>
</body>
</html>
