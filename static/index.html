<script>
  // ====== 共用：設定/取得欄位 ======
  function setLatLng(lat, lng) {
    document.getElementById('lat').value = (lat ?? '').toString();
    document.getElementById('lng').value = (lng ?? '').toString();
  }

  async function updateLocation(lat, lng) {
    try {
      const r = await fetch(`${API_BASE}/me/location`, {
        method:'POST',
        headers:{'Content-Type':'application/json', ...authHeader()},
        body: JSON.stringify({lat, lng})
      });
      return r.ok;
    } catch {
      return false;
    }
  }

  // ====== 一次抓定位 ======
  const geoMsg = document.getElementById('geoMsg');

  function isSecureContextForGeo() {
    return location.protocol === 'https:' ||
           location.hostname === 'localhost' ||
           location.hostname === '127.0.0.1';
  }

  function geoErrorTips(err) {
    if (!isSecureContextForGeo()) return '（需要 HTTPS 或本機）';
    switch (err.code) {
      case 1: return '（你拒絕了定位權限）';
      case 2: return '（無法取得位置，請稍後重試）';
      case 3: return '（定位逾時，請再試一次）';
      default: return '';
    }
  }

  document.getElementById('btnGeo').onclick = () => {
    if (!navigator.geolocation) { geoMsg.textContent = '此瀏覽器不支援定位'; return; }
    if (!isSecureContextForGeo()) { geoMsg.textContent = '需要在 HTTPS 或本機環境使用定位'; return; }

    geoMsg.textContent = '定位中…（請在瀏覽器允許定位權限）';
    navigator.geolocation.getCurrentPosition(async pos => {
      const { latitude, longitude } = pos.coords;
      setLatLng(latitude, longitude);
      geoMsg.textContent = `已取得：${latitude.toFixed(6)}, ${longitude.toFixed(6)}`;

      // 已登入則自動回報到後端
      if (getToken()) {
        const ok = await updateLocation(latitude, longitude);
        if (!ok) geoMsg.textContent += '；回報後端失敗';
        else geoMsg.textContent += '；已回報後端';
      }
    }, err => {
      geoMsg.textContent = `定位失敗：${err.message} ${geoErrorTips(err)}`;
    }, { enableHighAccuracy: true, timeout: 10000, maximumAge: 30000 });
  };

  // ====== 持續追蹤定位（移動時自動回報） ======
  let geoWatchId = null;
  let lastSentAt = 0;
  let lastSentLat = null, lastSentLng = null;

  function haversineKm(lat1, lon1, lat2, lon2) {
    const R = 6371, toRad = d => d * Math.PI / 180;
    const dphi = toRad(lat2 - lat1), dlmb = toRad(lon2 - lon1);
    const a = Math.sin(dphi/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dlmb/2)**2;
    return 2 * R * Math.asin(Math.sqrt(a));
  }

  async function maybeSendUpdate(lat, lng) {
    const now = Date.now();
    const movedEnough = (lastSentLat == null) ? true : (haversineKm(lat, lng, lastSentLat, lastSentLng) >= 0.05); // >= 50 公尺
    const timeOk = (now - lastSentAt) >= 10000; // >= 10 秒
    if (movedEnough && timeOk && getToken()) {
      const ok = await updateLocation(lat, lng);
      if (ok) { lastSentAt = now; lastSentLat = lat; lastSentLng = lng; }
    }
  }

  document.getElementById('btnWatch').onclick = () => {
    if (geoWatchId) return; // 已在追蹤
    if (!navigator.geolocation) { geoMsg.textContent = '此瀏覽器不支援定位'; return; }
    if (!isSecureContextForGeo()) { geoMsg.textContent = '需要在 HTTPS 或本機環境使用定位'; return; }

    geoMsg.textContent = '開始追蹤定位…（允許權限後會持續更新）';
    geoWatchId = navigator.geolocation.watchPosition(async pos => {
      const { latitude, longitude } = pos.coords;
      setLatLng(latitude, longitude);
      geoMsg.textContent = `追蹤中：${latitude.toFixed(6)}, ${longitude.toFixed(6)}`;
      await maybeSendUpdate(latitude, longitude);
    }, err => {
      geoMsg.textContent = `追蹤失敗：${err.message} ${geoErrorTips(err)}`;
    }, { enableHighAccuracy: true, timeout: 15000, maximumAge: 5000 });

    document.getElementById('btnWatch').disabled = true;
    document.getElementById('btnStopWatch').disabled = false;
  };

  document.getElementById('btnStopWatch').onclick = () => {
    if (geoWatchId) {
      navigator.geolocation.clearWatch(geoWatchId);
      geoWatchId = null;
      geoMsg.textContent = '已停止追蹤';
    }
    document.getElementById('btnWatch').disabled = false;
    document.getElementById('btnStopWatch').disabled = true;
  };

  // ====== 既有按鈕沿用共用方法 ======
  document.getElementById('btnUpdateLoc').onclick = async () => {
    const lat = parseFloat(document.getElementById('lat').value);
    const lng = parseFloat(document.getElementById('lng').value);
    const ok = await updateLocation(lat, lng);
    alert(ok ? '定位已更新' : '更新失敗');
  };

  document.getElementById('btnNearby').onclick = async () => {
    const lat = parseFloat(document.getElementById('lat').value);
    const lng = parseFloat(document.getElementById('lng').value);
    const radius_km = parseFloat(document.getElementById('radius').value || '5');
    const out = document.getElementById('nearbyOut');
    out.textContent = '搜尋中…';
    try{
      const r = await fetch(`${API_BASE}/nearby`, {
        method:'POST',
        headers:{'Content-Type':'application/json',...authHeader()},
        body: JSON.stringify({lat, lng, radius_km})
      });
      const txt = await r.text();
      let data;
      try { data = JSON.parse(txt); } catch { data = { detail: txt }; }
      out.textContent = r.ok ? JSON.stringify(data, null, 2) : `錯誤：${data.detail || '搜尋失敗'}`;
    }catch(e){
      out.textContent = `錯誤：${e.message || e}`;
    }
  };

  // （可選）如果你想「一開頁就自動抓一次」→ 取消下行註解
  // if (isSecureContextForGeo()) document.getElementById('btnGeo').click();
</script>
