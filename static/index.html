<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>遊戲配對網</title>
  <style>
    :root{--bg:#f7f7fb;--card:#fff;--text:#222;--muted:#667;--pri:#2962ff;--ok:#0aa56b}
    *{box-sizing:border-box}body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,"Segoe UI","Noto Sans TC",Roboto,Arial}
    .wrap{max-width:1100px;margin:28px auto;padding:0 16px}
    h1{margin:0 0 16px}.row{display:flex;gap:18px;flex-wrap:wrap}
    .col{flex:1 1 420px;min-width:320px}
    .card{background:var(--card);border-radius:14px;box-shadow:0 6px 20px rgba(0,0,0,.08);padding:18px 20px;margin:18px 0}
    label{display:block;font-size:14px;margin:8px 0 6px;color:#444}
    input,select,textarea{width:100%;padding:10px 12px;border:1px solid #d7d7e0;border-radius:10px;font-size:15px;outline:none}
    input:focus,textarea:focus{border-color:#5b8def;box-shadow:0 0 0 3px rgba(91,141,239,.15)}
    .btn{display:inline-block;background:var(--pri);color:#fff;border:0;border-radius:10px;padding:10px 16px;font-weight:600;cursor:pointer}
    .btn.green{background:var(--ok)}.btn.gray{background:#e5e7eb;color:#111}.btn.red{background:#e63b3b}
    .muted{color:var(--muted);font-size:13px}
    .status{font-weight:700;padding:3px 9px;border-radius:999px}
    .ok{background:#e6f7ef;color:#117a47}.bad{background:#fde8e8;color:#9b2226}
    .list{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:12px}
    .match{border:1px solid #e6e6ef;border-radius:12px;padding:12px}
    .match h4{margin:0 0 6px}.tag{display:inline-block;background:#eef;border-radius:999px;padding:2px 8px;margin:2px 6px 0 0;font-size:12px}
    .flex{display:flex;gap:8px;align-items:center}.right{margin-left:auto}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center}
    .modal>.box{background:#fff;max-width:560px;width:calc(100% - 32px);padding:18px;border-radius:12px}
    .chat{height:360px;border:1px solid #e1e1ea;border-radius:10px;padding:8px;overflow:auto;background:#fafafe}
    .bubble{background:#fff;border-radius:10px;padding:6px 10px;margin:6px 0;max-width:80%}
    .me{background:#dff1ff;margin-left:auto}
  </style>
</head>
<body>
<div class="wrap">
  <h1>遊戲配對網</h1>

  <div class="card">
    <div class="flex">
      <div>登入狀態：<span id="authStatus" class="status bad">未登入</span></div>
      <div class="right">
        <button class="btn gray" id="btnLogout">登出</button>
        <a class="btn gray" href="/disclaimer" target="_blank">免責聲明</a>
        <a class="btn gray" href="/privacy" target="_blank">隱私權政策</a>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="card col">
      <h3>註冊 / 登入</h3>
      <label>帳號</label><input id="lg_user">
      <label>密碼</label><input id="lg_pass" type="password">
      <div class="flex" style="gap:8px;margin-top:10px">
        <button class="btn" id="btnLogin">登入</button>
        <button class="btn green" id="btnSignup">註冊</button>
        <span id="authMsg" class="muted"></span>
      </div>
      <div class="muted" style="margin-top:8px">註冊代表你已閱讀並同意<a href="/disclaimer" target="_blank">免責聲明</a>與<a href="/privacy" target="_blank">隱私權政策</a>。</div>
    </div>

    <div class="card col">
      <h3>我的個人檔案</h3>
      <div class="flex" style="gap:8px;margin-bottom:8px">
        <button class="btn gray" id="btnLoadMe">讀取</button>
        <button class="btn" id="btnSaveMe">儲存</button>
        <span id="meMsg" class="muted"></span>
      </div>
      <label>暱稱</label><input id="pf_display">
      <label>性別</label>
      <select id="pf_gender">
        <option value="">不顯示</option>
        <option value="男">男</option>
        <option value="女">女</option>
        <option value="其他">其他</option>
      </select>
      <label>生日</label><input id="pf_birth" type="date">
      <label>自我介紹</label><textarea id="pf_bio" rows="3"></textarea>
      <label>興趣標籤（以逗號分隔）</label><input id="pf_interests" placeholder="LOL, VALORANT, 登山">
      <label>城市</label><input id="pf_city" placeholder="台北市">
    </div>
  </div>

  <div class="row">
    <div class="card col">
      <h3>定位</h3>
      <label>緯度</label><input id="lat" readonly>
      <label>經度</label><input id="lng" readonly>
      <label>半徑（公里）</label><input id="radius" value="100">
      <div class="muted" id="geoMsg" style="margin-top:6px">登入後會自動偵測並回報定位。</div>
    </div>

    <div class="card col">
      <h3>附近（表單過濾配對）</h3>
      <label>性別</label>
      <select id="fil_gender">
        <option value="">不限</option><option value="男">男</option><option value="女">女</option><option value="其他">其他</option>
      </select>
      <label>最小年齡</label><input id="fil_age_min" type="number" min="0" placeholder="">
      <label>最大年齡</label><input id="fil_age_max" type="number" min="0" placeholder="">
      <label>興趣（逗號，英文自動大寫）</label><input id="fil_interest" placeholder="LOL">
      <div class="flex" style="gap:8px;margin-top:10px">
        <button class="btn" id="btnNearby">搜尋</button>
        <span id="nearbyMsg" class="muted"></span>
      </div>
      <div class="list" id="nearbyList" style="margin-top:10px"></div>
      <button class="btn green" id="btnLikeSel" style="margin-top:8px">對勾選的人按讚</button>
      <span id="likeMsg" class="muted"></span>
    </div>
  </div>

  <div class="card">
    <div class="flex" style="gap:8px"><h3 style="margin:0">我的配對</h3>
      <button class="btn gray" id="btnLoadMatches">重新整理</button>
      <span id="matchMsg" class="muted"></span>
    </div>
    <div class="list" id="matchList" style="margin-top:10px"></div>
  </div>
</div>

<!-- 聊天 Modal -->
<div class="modal" id="chatModal">
  <div class="box">
    <div class="flex"><h3 id="chatTitle" style="margin:0">聊天</h3><button class="btn gray right" id="chatClose">關閉</button></div>
    <div class="chat" id="chatBox"></div>
    <div class="flex" style="gap:8px;margin-top:8px">
      <input id="chatInput" placeholder="輸入訊息…"><button class="btn" id="chatSend">送出</button>
      <span class="muted" id="chatMsg"></span>
    </div>
  </div>
</div>

<script>
  // —— 後端 API 位址（隱藏，使用同源） ——
  const API = location.origin;

  const $ = (s)=>document.querySelector(s);
  const authStatus = $('#authStatus');
  const tokenKey = 'authToken';
  const setToken = t => localStorage.setItem(tokenKey, t);
  const getToken = ()=> localStorage.getItem(tokenKey)||'';
  const clearToken = ()=> localStorage.removeItem(tokenKey);

  function authHeader(){
    const t = getToken();
    return t ? {'Authorization':'Bearer '+t} : {};
  }
  function refreshAuthStatus(){
    if(getToken()){ authStatus.textContent='已登入'; authStatus.className='status ok'; }
    else { authStatus.textContent='未登入'; authStatus.className='status bad'; }
  }
  refreshAuthStatus();

  // —— 註冊/登入 ——
  $('#btnSignup').onclick = async ()=>{
    const username = $('#lg_user').value.trim();
    const password = $('#lg_pass').value;
    $('#authMsg').textContent = '註冊中…';
    try{
      const r = await fetch(API+'/auth/signup',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({username,password,consent_agreed:true})});
      const d = await r.json(); if(!r.ok) throw new Error(d.detail||r.statusText);
      $('#authMsg').textContent = '註冊成功，請登入。';
    }catch(e){ $('#authMsg').textContent = '失敗：'+e.message; }
  };

  $('#btnLogin').onclick = async ()=>{
    const username = $('#lg_user').value.trim();
    const password = $('#lg_pass').value;
    $('#authMsg').textContent = '登入中…';
    try{
      const r = await fetch(API+'/auth/login',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({username,password})});
      const d = await r.json(); if(!r.ok) throw new Error(d.detail||r.statusText);
      setToken(d.access_token); refreshAuthStatus();
      $('#authMsg').textContent = '登入成功！';
      autoLoc(); // 登入後自動定位
    }catch(e){ $('#authMsg').textContent = '失敗：'+e.message; }
  };

  $('#btnLogout').onclick = ()=>{ clearToken(); refreshAuthStatus(); };

  // —— 讀取/儲存我的資料 ——
  $('#btnLoadMe').onclick = loadMe;
  async function loadMe(){
    if(!getToken()){ $('#meMsg').textContent='請先登入'; return; }
    $('#meMsg').textContent='讀取中…';
    try{
      const r = await fetch(API+'/me',{headers:{...authHeader()}});
      const d = await r.json(); if(!r.ok) throw new Error(d.detail||r.statusText);
      $('#pf_display').value = d.display_name||'';
      $('#pf_gender').value = d.gender||'';
      $('#pf_birth').value = d.birthday||'';
      $('#pf_bio').value = d.bio||'';
      $('#pf_interests').value = (d.interests||[]).join(', ');
      $('#pf_city').value = d.city||'';
      $('#lat').value = d.lat??''; $('#lng').value = d.lng??'';
      $('#meMsg').textContent='完成';
    }catch(e){ $('#meMsg').textContent='錯誤：'+e.message; }
  }

  $('#btnSaveMe').onclick = async ()=>{
    if(!getToken()){ $('#meMsg').textContent='請先登入'; return; }
    const interests = $('#pf_interests').value.split(',').map(x=>x.trim()).filter(Boolean);
    $('#meMsg').textContent='儲存中…';
    try{
      const r = await fetch(API+'/me',{method:'PATCH',headers:{'Content-Type':'application/json',...authHeader()},
        body:JSON.stringify({display_name:$('#pf_display').value.trim(),gender:$('#pf_gender').value,birthday:$('#pf_birth').value||null,
          bio:$('#pf_bio').value,interests,city:$('#pf_city').value.trim()})});
      const d = await r.json(); if(!r.ok) throw new Error(d.detail||r.statusText);
      $('#meMsg').textContent='已儲存';
    }catch(e){ $('#meMsg').textContent='失敗：'+e.message; }
  };

  // —— 自動定位並回報 ——
  async function autoLoc(){
    if(!getToken()) return;
    if(!navigator.geolocation){ $('#geoMsg').textContent='此裝置不支援定位'; return; }
    $('#geoMsg').textContent='定位中…';
    navigator.geolocation.getCurrentPosition(async pos=>{
      const lat = pos.coords.latitude.toFixed(6), lng = pos.coords.longitude.toFixed(6);
      $('#lat').value = lat; $('#lng').value = lng;
      try{
        const r = await fetch(API+'/me/location',{method:'POST',headers:{'Content-Type':'application/json',...authHeader()},
          body:JSON.stringify({lat:Number(lat),lng:Number(lng)})});
        if(!r.ok){ const d = await r.json(); throw new Error(d.detail||r.statusText); }
        $('#geoMsg').textContent='定位已回報';
      }catch(e){ $('#geoMsg').textContent='定位回報失敗：'+e.message; }
    }, err=>{ $('#geoMsg').textContent='定位失敗'; });
  }
  // 自動嘗試
  autoLoc();

  // —— 附近搜尋 / 按讚 ——
  $('#btnNearby').onclick = async ()=>{
    if(!getToken()){ $('#nearbyMsg').textContent='請先登入'; return; }
    const lat = Number($('#lat').value||0), lng = Number($('#lng').value||0), radius_km = Number($('#radius').value||100);
    $('#nearbyMsg').textContent='搜尋中…';
    try{
      const r = await fetch(API+'/nearby',{method:'POST',headers:{'Content-Type':'application/json',...authHeader()},
        body:JSON.stringify({lat,lng,radius_km})});
      const d = await r.json(); if(!r.ok) throw new Error(d.detail||r.statusText);
      const wantGender = $('#fil_gender').value;
      const ageMin = Number($('#fil_age_min').value||0), ageMax = Number($('#fil_age_max').value||999);
      let interest = ($('#fil_interest').value||'').trim(); if(interest) interest = interest.toUpperCase();

      const list = d.users.filter(u=>{
        if(wantGender && u.gender!==wantGender) return false;
        const age = u.birthday ? Math.max(0, Math.floor((Date.now()-Date.parse(u.birthday))/31557600000)) : 0;
        if(ageMin && age<ageMin) return false;
        if(ageMax && age>ageMax) return false;
        if(interest && !(u.interests||[]).map(x=>x.toUpperCase()).includes(interest)) return false;
        return true;
      });

      const box = $('#nearbyList'); box.innerHTML='';
      list.forEach(u=>{
        const dkm = (u.distance_km??0).toFixed(3);
        const div = document.createElement('div'); div.className='match';
        div.innerHTML = `
          <div class="flex"><label class="flex" style="gap:6px"><input type="checkbox" class="pick" data-user="${u.username}">
            <b>${(u.display_name||u.username)}</b></label><span class="right muted">${u.gender||''} / ${u.city||''} / ${dkm} km</span></div>
          <div class="muted">${(u.bio||'')}</div>
          <div>${(u.interests||[]).map(i=>`<span class="tag">${i}</span>`).join('')}</div>`;
        box.appendChild(div);
      });
      $('#nearbyMsg').textContent = `找到 ${list.length} 位`;
    }catch(e){ $('#nearbyMsg').textContent='錯誤：'+e.message; }
  };

  $('#btnLikeSel').onclick = async ()=>{
    const picks = [...document.querySelectorAll('.pick:checked')].map(x=>x.dataset.user);
    if(!picks.length){ $('#likeMsg').textContent='請勾選'; return; }
    $('#likeMsg').textContent='送出中…';
    let ok=0, match=0;
    for(const u of picks){
      try{
        const r = await fetch(API+'/like',{method:'POST',headers:{'Content-Type':'application/json',...authHeader()},body:JSON.stringify({target:u})});
        const d = await r.json(); if(r.ok){ ok++; if(d.matched) match++; }
      }catch{}
    }
    $('#likeMsg').textContent=`完成：成功 ${ok}，其中配對 ${match}`;
  };

  // —— 我的配對 + 聊天 ——
  $('#btnLoadMatches').onclick = loadMatches;
  async function loadMatches(){
    if(!getToken()){ $('#matchMsg').textContent='請先登入'; return; }
    $('#matchMsg').textContent='讀取中…';
    try{
      const r = await fetch(API+'/matches',{headers:{...authHeader()}});
      const d = await r.json(); if(!r.ok) throw new Error(d.detail||r.statusText);
      const box = $('#matchList'); box.innerHTML='';
      d.matches.forEach(u=>{
        const age = u.birthday ? Math.max(0, Math.floor((Date.now()-Date.parse(u.birthday))/31557600000)) : '';
        const div = document.createElement('div'); div.className='match';
        div.innerHTML = `
          <h4>${u.display_name||u.username}</h4>
          <div class="muted">@${u.username} ｜ ${u.gender||''} ${age?`｜ ${age} 歲`:''} ｜ ${u.city||''}</div>
          <div class="muted" style="margin:6px 0">${u.bio||'（尚未撰寫自我介紹）'}</div>
          <div>${(u.interests||[]).map(i=>`<span class="tag">${i}</span>`).join('')}</div>
          <div class="flex" style="margin-top:8px"><span class="muted"></span>
            <button class="btn right openChat" data-user="${u.username}" data-name="${u.display_name||u.username}">開啟聊天</button>
          </div>`;
        box.appendChild(div);
      });
      [...document.querySelectorAll('.openChat')].forEach(btn=>btn.onclick=()=>openChat(btn.dataset.user, btn.dataset.name));
      $('#matchMsg').textContent = `共 ${d.matches.length} 組配對`;
    }catch(e){ $('#matchMsg').textContent='錯誤：'+e.message; }
  }

  // 聊天
  let ws=null, chattingUser='';
  async function openChat(username, display){
    if(!getToken()) return;
    chattingUser = username;
    $('#chatTitle').textContent = `與 ${display} 的聊天`;
    $('#chatBox').innerHTML = ''; $('#chatMsg').textContent='';
    $('#chatModal').style.display='flex';

    // 載入歷史
    try{
      const r = await fetch(`${API}/messages/${username}`,{headers:{...authHeader()}});
      const d = await r.json();
      if(r.ok){ d.messages.forEach(addBubble); }
    }catch{}

    // 連線 websocket
    try{
      const proto = location.protocol==='https:' ? 'wss' : 'ws';
      ws = new WebSocket(`${proto}://${location.host}/ws?token=${encodeURIComponent(getToken())}&peer=${encodeURIComponent(username)}`);
      ws.onmessage = (ev)=>{ try{ const m = JSON.parse(ev.data); addBubble(m); }catch{} };
      ws.onclose = ()=>{ /* no-op */ };
    }catch(e){ $('#chatMsg').textContent='WebSocket 連線失敗'; }
  }
  function addBubble(m){
    const me = $('#lg_user').value.trim();
    const isMe = (m.sender===me);
    const div = document.createElement('div'); div.className='bubble'+(isMe?' me':'');
    div.textContent = `${m.sender}: ${m.content}`;
    $('#chatBox').appendChild(div); $('#chatBox').scrollTop = 1e9;
  }
  $('#chatSend').onclick = async ()=>{
    const txt = $('#chatInput').value.trim(); if(!txt) return;
    $('#chatInput').value='';
    // 先走 REST（後端會廣播 WS）
    try{
      const r = await fetch(`${API}/messages/${chattingUser}`,{method:'POST',headers:{'Content-Type':'application/json',...authHeader()},body:JSON.stringify({content:txt})});
      if(!r.ok){ const d = await r.json(); throw new Error(d.detail||r.statusText); }
    }catch(e){ $('#chatMsg').textContent='送出失敗：'+e.message; }
  };
  $('#chatClose').onclick = ()=>{ $('#chatModal').style.display='none'; try{ ws && ws.close(); }catch{} };

</script>
</body>
</html>
