<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>交友APP 前端（原型）</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen">
  <div class="max-w-5xl mx-auto p-4 space-y-6">
    <header class="flex items-center justify-between">
      <h1 class="text-2xl font-bold">交友APP 前端（原型）</h1>
      <div class="text-sm text-gray-500">請先啟動後端：<code>uvicorn app:app --reload</code></div>
    </header>

    <!-- API 位置設定 -->
    <section class="bg-white rounded-2xl shadow p-4">
      <h2 class="font-semibold text-lg mb-2">API 位置</h2>
      <div class="flex flex-wrap gap-2 items-center">
        <input id="apiBase" class="border rounded px-3 py-2 w-full sm:w-96" value="http://127.0.0.1:8000" />
        <button id="pingBtn" class="px-3 py-2 rounded bg-gray-800 text-white">測試連線</button>
        <span id="pingMsg" class="text-sm ml-2"></span>
      </div>
    </section>

    <!-- 註冊 / 登入 -->
    <section class="grid md:grid-cols-2 gap-4">
      <div class="bg-white rounded-2xl shadow p-4">
        <h2 class="font-semibold text-lg mb-3">註冊</h2>
        <div class="space-y-2">
          <input id="suUser" class="w-full border rounded px-3 py-2" placeholder="用戶名" />
          <input id="suPass" type="password" class="w-full border rounded px-3 py-2" placeholder="密碼 (≥6)" />
          <input id="suEmail" class="w-full border rounded px-3 py-2" placeholder="電子信箱 (可空白)" />
          <button id="signupBtn" class="w-full px-3 py-2 rounded bg-blue-600 text-white">建立帳號</button>
          <div id="signupMsg" class="text-sm"></div>
        </div>
      </div>

      <div class="bg-white rounded-2xl shadow p-4">
        <h2 class="font-semibold text-lg mb-3">登入</h2>
        <div class="space-y-2">
          <input id="liUser" class="w-full border rounded px-3 py-2" placeholder="用戶名" />
          <input id="liPass" type="password" class="w-full border rounded px-3 py-2" placeholder="密碼" />
          <button id="loginBtn" class="w-full px-3 py-2 rounded bg-emerald-600 text-white">登入</button>
          <div class="text-xs text-gray-500">登入成功後會儲存 Token 於本地（只在此頁面用）。</div>
          <div id="loginMsg" class="text-sm"></div>
        </div>
      </div>
    </section>

    <!-- Token 狀態 -->
    <section class="bg-white rounded-2xl shadow p-4">
      <div class="flex flex-wrap items-center gap-2">
        <span class="font-semibold">登入狀態：</span>
        <span id="authState" class="px-2 py-1 rounded text-white bg-red-500">未登入</span>
        <button id="logoutBtn" class="ml-auto px-3 py-2 rounded bg-gray-200">登出</button>
      </div>
      <div class="mt-2 text-xs text-gray-500 break-all" id="tokenPreview"></div>
    </section>

    <!-- 個人資料 -->
    <section class="bg-white rounded-2xl shadow p-4">
      <h2 class="font-semibold text-lg mb-3">我的資料</h2>
      <div class="flex flex-wrap gap-2 items-center mb-3">
        <button id="meBtn" class="px-3 py-2 rounded bg-gray-800 text-white">取得 / 更新顯示</button>
        <span id="meMsg" class="text-sm"></span>
      </div>
      <div class="grid md:grid-cols-3 gap-3">
        <div>
          <label class="text-sm text-gray-500">自我介紹</label>
          <textarea id="meBio" class="w-full border rounded px-3 py-2" rows="3" placeholder="Hi！很高興認識你～"></textarea>
        </div>
        <div>
          <label class="text-sm text-gray-500">性別</label>
          <input id="meGender" class="w-full border rounded px-3 py-2" placeholder="男 / 女 / 其他" />
        </div>
        <div>
          <label class="text-sm text-gray-500">生日</label>
          <input id="meBirth" type="date" class="w-full border rounded px-3 py-2" />
        </div>
      </div>
      <div class="mt-3">
        <button id="meUpdateBtn" class="px-3 py-2 rounded bg-blue-600 text-white">儲存資料</button>
        <span id="meUpdateMsg" class="text-sm ml-2"></span>
      </div>
    </section>

    <!-- 定位 -->
    <section class="bg-white rounded-2xl shadow p-4">
      <h2 class="font-semibold text-lg mb-3">定位</h2>
      <div class="flex flex-wrap items-center gap-2">
        <button id="geoBtn" class="px-3 py-2 rounded bg-indigo-600 text-white">使用瀏覽器定位</button>
        <input id="lat" class="border rounded px-3 py-2 w-40" placeholder="緯度" />
        <input id="lng" class="border rounded px-3 py-2 w-40" placeholder="經度" />
        <button id="locSendBtn" class="px-3 py-2 rounded bg-indigo-950 text-white">上傳定位</button>
        <span id="locMsg" class="text-sm"></span>
      </div>
    </section>

    <!-- 附近的人 -->
    <section class="bg-white rounded-2xl shadow p-4">
      <h2 class="font-semibold text-lg mb-3">附近的人</h2>
      <div class="flex flex-wrap items-center gap-2 mb-3">
        <input id="qRadius" type="number" class="border rounded px-3 py-2 w-32" value="5" />
        <label class="text-sm">公里</label>
        <input id="qActive" type="number" class="border rounded px-3 py-2 w-40" value="60" />
        <label class="text-sm">分鐘內上線</label>
        <button id="nearbyBtn" class="px-3 py-2 rounded bg-rose-600 text-white">搜尋</button>
        <span id="nearbyMsg" class="text-sm"></span>
      </div>
      <div id="nearbyList" class="grid md:grid-cols-2 gap-3"></div>
    </section>

    <!-- 配對 -->
    <section class="bg-white rounded-2xl shadow p-4">
      <div class="flex items-center justify-between mb-2">
        <h2 class="font-semibold text-lg">我的配對</h2>
        <button id="matchesBtn" class="px-3 py-2 rounded bg-teal-600 text-white">重新整理</button>
      </div>
      <div id="matchesList" class="grid md:grid-cols-2 gap-3"></div>
    </section>
  </div>

<script>
const $ = (id) => document.getElementById(id);
const state = {
  token: localStorage.getItem('token') || '',
  api() { return ($('apiBase').value || '').replace(/\/$/, ''); }
};

function setAuthState() {
  const badge = $('authState');
  if (state.token) { badge.textContent = '已登入'; badge.className = 'px-2 py-1 rounded text-white bg-green-600'; }
  else { badge.textContent = '未登入'; badge.className = 'px-2 py-1 rounded text-white bg-red-500'; }
  $('tokenPreview').textContent = state.token ? `Bearer ${state.token}` : '';
}

async function api(path, opts={}) {
  const headers = {'Content-Type': 'application/json', ...(opts.headers||{})};
  if (state.token) headers['Authorization'] = `Bearer ${state.token}`;
  const res = await fetch(state.api() + path, {...opts, headers});
  if (!res.ok) throw new Error(await res.text());
  return res.json();
}

// 連線測試
$('pingBtn').onclick = async () => {
  $('pingMsg').textContent = '測試中…';
  try { const r = await api('/'); $('pingMsg').textContent = r.ok ? '連線成功' : '無回應'; }
  catch(e){ $('pingMsg').textContent = '連線失敗'; }
};

// 註冊
$('signupBtn').onclick = async () => {
  $('signupMsg').textContent = '處理中…';
  try {
    const body = { username: $('suUser').value, password: $('suPass').value };
    const email = $('suEmail').value.trim(); if (email) body.email = email;
    const r = await api('/auth/signup', {method:'POST', body: JSON.stringify(body)});
    state.token = r.access_token; localStorage.setItem('token', state.token); setAuthState();
    $('signupMsg').textContent = '註冊成功，已登入';
  } catch(e){ $('signupMsg').textContent = '失敗：' + e.message; }
};

// 登入
$('loginBtn').onclick = async () => {
  $('loginMsg').textContent = '處理中…';
  try {
    const body = { username: $('liUser').value, password: $('liPass').value };
    const r = await api('/auth/login', {method:'POST', body: JSON.stringify(body)});
    state.token = r.access_token; localStorage.setItem('token', state.token); setAuthState();
    $('loginMsg').textContent = '登入成功';
  } catch(e){ $('loginMsg').textContent = '失敗：' + e.message; }
};

$('logoutBtn').onclick = () => { state.token=''; localStorage.removeItem('token'); setAuthState(); };

// 我的資料
$('meBtn').onclick = async () => {
  $('meMsg').textContent = '載入中…';
  try {
    const me = await api('/me');
    $('meBio').value = me.bio || '';
    $('meGender').value = me.gender || '';
    $('meBirth').value = me.birthdate || '';
    $('meMsg').textContent = `你好，${me.username}（ID: ${me.id}）`;
  } catch(e){ $('meMsg').textContent = '失敗：' + e.message; }
};

$('meUpdateBtn').onclick = async () => {
  $('meUpdateMsg').textContent = '儲存中…';
  try {
    const body = { bio: $('meBio').value, gender: $('meGender').value, birthdate: $('meBirth').value || null };
    const me = await api('/me', {method:'PATCH', body: JSON.stringify(body)});
    $('meUpdateMsg').textContent = '已儲存';
  } catch(e){ $('meUpdateMsg').textContent = '失敗：' + e.message; }
};

// 取得定位
$('geoBtn').onclick = () => {
  if (!navigator.geolocation) return alert('此瀏覽器不支援定位');
  navigator.geolocation.getCurrentPosition(pos => {
    $('lat').value = pos.coords.latitude.toFixed(6);
    $('lng').value = pos.coords.longitude.toFixed(6);
  }, err => alert('定位失敗：' + err.message), { enableHighAccuracy:true, timeout:10000 });
};

// 上傳定位
$('locSendBtn').onclick = async () => {
  $('locMsg').textContent = '上傳中…';
  try {
    const body = { lat: parseFloat($('lat').value), lng: parseFloat($('lng').value) };
    const r = await api('/me/location', {method:'POST', body: JSON.stringify(body)});
    $('locMsg').textContent = '完成';
  } catch(e){ $('locMsg').textContent = '失敗：' + e.message; }
};

// 附近的人
$('nearbyBtn').onclick = async () => {
  $('nearbyMsg').textContent = '查詢中…';
  try {
    const lat = parseFloat($('lat').value); const lng = parseFloat($('lng').value);
    if (Number.isNaN(lat) || Number.isNaN(lng)) { $('nearbyMsg').textContent = '請先填好緯度/經度或使用定位'; return; }
    const body = { lat, lng, radius_km: parseFloat($('qRadius').value), active_within_min: parseInt($('qActive').value,10) };
    const list = await api('/nearby', {method:'POST', body: JSON.stringify(body)});
    $('nearbyList').innerHTML = list.map(u => `
      <div class='border rounded-xl p-3 flex items-center justify-between'>
        <div>
          <div class='font-semibold'>${u.username} (ID: ${u.id})</div>
          <div class='text-sm text-gray-600'>距離：${u.distance_km} 公里</div>
          <div class='text-sm text-gray-600 truncate max-w-[28ch]'>${u.bio || ''}</div>
        </div>
        <button class='px-3 py-2 rounded bg-pink-600 text-white' onclick='likeUser(${u.id})'>喜歡</button>
      </div>`).join('');
    $('nearbyMsg').textContent = `找到 ${list.length} 位使用者`;
  } catch(e){ $('nearbyMsg').textContent = '失敗：' + e.message; }
};

window.likeUser = async function(id){
  try {
    const r = await api(`/like/${id}`, {method:'POST'});
    alert(r.is_match ? '配對成功！🎉' : '已送出喜歡');
  } catch(e){ alert('失敗：' + e.message); }
}

// 配對
$('matchesBtn').onclick = async () => {
  try {
    const list = await api('/matches');
    $('matchesList').innerHTML = list.map(u => `
      <div class='border rounded-xl p-3'>
        <div class='font-semibold'>${u.username} (ID: ${u.id})</div>
        <div class='text-sm text-gray-600'>${u.bio || ''}</div>
      </div>`).join('');
  } catch(e){ alert('讀取配對失敗：' + e.message); }
};

setAuthState();
</script>
</body>
</html>
