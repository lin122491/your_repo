<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>遊戲配對網</title>
  <style>
    :root { --bg:#f7f7fb; --card:#fff; --muted:#667; --line:#e5e7eb; --pri:#2962ff; --ok:#0aa56b; }
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:#222;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans TC","Helvetica Neue",Arial}
    .wrap{max-width:1100px;margin:32px auto;padding:0 16px}
    h1{margin:0 0 18px}
    .grid{display:grid;gap:16px}
    .col2{grid-template-columns:1fr 1fr}
    .card{background:var(--card);border-radius:14px;box-shadow:0 8px 22px rgba(0,0,0,.08);padding:16px 18px}
    label{display:block;margin:10px 0 6px;color:#444}
    input,select,textarea{width:100%;border:1px solid var(--line);border-radius:10px;padding:10px 12px;font-size:15px;outline:none}
    input:focus,textarea:focus{border-color:#5b8def;box-shadow:0 0 0 3px rgba(91,141,239,.15)}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .btn{border:0;border-radius:10px;padding:10px 16px;background:var(--pri);color:#fff;cursor:pointer;font-weight:600}
    .btn.gray{background:#eceff4;color:#111}
    .btn.ok{background:var(--ok)}
    .muted{color:#666;font-size:13px}
    .pill{display:inline-block;border-radius:999px;background:#eef;padding:4px 8px;margin:2px 6px 2px 0;font-size:12px}
    .list{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:12px}
    .card-sm{border:1px solid var(--line);border-radius:12px;padding:12px}
    .title{font-weight:700;margin-bottom:4px}
    .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
    .hr{height:1px;background:var(--line);margin:14px 0}
  </style>
</head>
<body>
<div class="wrap">
  <h1>遊戲配對網</h1>

  <div class="grid col2" style="margin-top:16px">
    <div class="card">
      <h3>註冊 / 登入</h3>
      <div class="row">
        <div style="flex:1">
          <label>用戶名</label><input id="li_username" autocomplete="username">
        </div>
        <div style="flex:1">
          <label>密碼</label><input id="li_password" type="password" autocomplete="current-password">
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <button class="btn ok" id="btnLogin">登入</button>
        <span class="muted">或</span>
        <button class="btn" id="btnSignup">建立帳號</button>
        <span id="authMsg" class="muted"></span>
      </div>
      <div class="row" style="margin-top:8px">
        <div>登入狀態：<span id="authStatus" class="pill">未登入</span></div>
        <button class="btn gray" id="btnLogout">登出</button>
      </div>
    </div>

    <div class="card">
      <h3>我的資料</h3>
      <div class="grid col2">
        <div><label>暱稱</label><input id="pf_nickname"></div>
        <div>
          <label>性別</label>
          <select id="pf_gender">
            <option value="">未指定</option>
            <option value="male">男</option>
            <option value="female">女</option>
          </select>
        </div>
        <div><label>生日</label><input id="pf_birthday" type="date"></div>
        <div><label>城市</label><input id="pf_city" placeholder="例如 台北市"></div>
        <div class="col2" style="grid-column:1/-1">
          <label>自我介紹</label><textarea id="pf_bio" rows="3"></textarea>
        </div>
        <div class="col2" style="grid-column:1/-1">
          <label>興趣標籤（以逗號分隔，英文會自動轉大寫）</label><input id="pf_interests" placeholder="LOL, VALORANT, 登山">
        </div>
      </div>
      <div class="row" style="margin-top:10px">
        <button class="btn" id="btnMe">讀取我的個人檔案</button>
        <button class="btn ok" id="btnSaveProfile">儲存個人檔案</button>
        <span id="pfMsg" class="muted"></span>
      </div>
    </div>
  </div>

  <div class="grid col2" style="margin-top:16px">
    <div class="card">
      <h3>定位</h3>
      <div class="grid col2">
        <div><label>緯度</label><input id="loc_lat" class="mono"></div>
        <div><label>經度</label><input id="loc_lng" class="mono"></div>
        <div><label>半徑（公里）</label><input id="loc_radius" value="100" class="mono"></div>
      </div>
      <div class="row" style="margin-top:10px">
        <button class="btn" id="btnAutoLoc">自動偵測定位</button>
        <button class="btn gray" id="btnReportLoc">回報定位</button>
        <span id="locMsg" class="muted"></span>
      </div>
      <div class="muted" id="locNote" style="margin-top:6px">（登入後會自動回報，並每 2 分鐘更新一次）</div>
    </div>

    <div class="card">
      <h3>附近（表單過濾配對）</h3>
      <div class="grid col2">
        <div>
          <label>性別</label>
          <select id="nb_gender">
            <option value="">性別不限</option>
            <option value="male">男</option>
            <option value="female">女</option>
          </select>
        </div>
        <div><label>最小年齡</label><input id="nb_min" type="number" min="0"></div>
        <div><label>最大年齡</label><input id="nb_max" type="number" min="0"></div>
        <div><label>興趣（單一；英文自動轉大寫）</label><input id="nb_interest"></div>
      </div>
      <div class="row" style="margin-top:10px">
        <button class="btn" id="btnNearby">搜尋</button>
        <span id="nbMsg" class="muted"></span>
      </div>
      <div class="hr"></div>
      <div class="list" id="nearbyList"></div>
    </div>
  </div>

  <div class="card" id="myMatchesCard" style="margin-top:16px">
    <h3 style="margin:0 0 8px">我的配對（點卡片開聊天室）</h3>
    <div class="row">
      <button class="btn gray" id="btnReloadMatches">重新整理</button>
    </div>
    <div id="myMatches" class="list" style="margin-top:8px"></div>
  </div>

  <div class="card" style="margin-top:16px">
    <h3 style="margin:0 0 8px">聊天室</h3>
    <div class="grid col2" style="grid-template-columns: 300px 1fr;">
      <div>
        <div class="row" style="margin-bottom:8px">
          <button class="btn gray" id="btnReloadRooms">重新整理房間</button>
        </div>
        <div id="roomList" class="list" style="grid-template-columns: 1fr;"></div>
        <div class="muted" style="margin-top:6px">（僅能由「我的配對」點選開啟 DM）</div>
      </div>
      <div>
        <div id="chatHeader" class="muted" style="margin-bottom:8px">尚未選擇房間</div>
        <div id="chatBox" class="card-sm" style="height:320px; overflow:auto; background:#fafafa"></div>
        <div class="row" style="margin-top:8px">
          <input id="chatInput" placeholder="輸入訊息按 Enter 送出" style="flex:1">
          <button class="btn ok" id="btnSendChat">送出</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // ===== API：同源
  const API_BASE = window.location.origin;

  // ===== Auth 狀態
  const tokenKey = 'authToken';
  const authStatus = document.getElementById('authStatus');
  function getToken(){ return localStorage.getItem(tokenKey) || ''; }
  function setToken(t){ localStorage.setItem(tokenKey, t); refreshAuth(); }
  function clearToken(){ localStorage.removeItem(tokenKey); refreshAuth(); }
  function refreshAuth(){ authStatus.textContent = getToken() ? '已登入' : '未登入'; }
  refreshAuth();

  async function api(path, opt={}){
    const url = `${API_BASE}${path}`;
    opt.headers = opt.headers || {};
    if (!opt.headers['Content-Type'] && !(opt.body instanceof FormData)) {
      opt.headers['Content-Type'] = 'application/json';
    }
    const t = getToken(); if (t) opt.headers['Authorization'] = `Bearer ${t}`;
    const r = await fetch(url, opt);
    if (!r.ok) {
      let err = await r.text(); try { err = JSON.parse(err).detail || err } catch(e){}
      throw new Error(err);
    }
    const ct = r.headers.get('content-type') || '';
    return ct.includes('application/json') ? r.json() : r.text();
  }

  // ===== 登入 / 註冊 / 登出
  const authMsg = document.getElementById('authMsg');
  document.getElementById('btnLogin').onclick = async () => {
    authMsg.textContent = '登入中…';
    try{
      const r = await api('/auth/login', {method:'POST', body: JSON.stringify({
        username: document.getElementById('li_username').value.trim(),
        password: document.getElementById('li_password').value
      })});
      setToken(r.access_token);
      authMsg.textContent = '登入成功！';
      autoLocate(true);
      setTimeout(loadMe, 200);
      loadMyMatches();
      cacheMeId();
      loadMyChats();
    }catch(e){ authMsg.textContent = `登入失敗：${e.message}`; }
  };
  document.getElementById('btnSignup').onclick = async () => {
    authMsg.textContent = '註冊中…';
    try{
      await api('/auth/signup', {method:'POST', body: JSON.stringify({
        username: document.getElementById('li_username').value.trim(),
        password: document.getElementById('li_password').value
      })});
      authMsg.textContent = '註冊成功！請登入。';
    }catch(e){ authMsg.textContent = `失敗：${e.message}`; }
  };
  document.getElementById('btnLogout').onclick = () => { clearToken(); };

  // ===== 我的資料
  const pfMsg = document.getElementById('pfMsg');
  function sexLabel(g){ return g==='male'?'男':(g==='female'?'女':''); }
  function fillMe(m){
    document.getElementById('pf_nickname').value = m.nickname || '';
    document.getElementById('pf_gender').value = m.gender || '';
    document.getElementById('pf_birthday').value = (m.birthday || '').slice(0,10);
    document.getElementById('pf_city').value = m.city || '';
    document.getElementById('pf_bio').value = m.bio || '';
    document.getElementById('pf_interests').value = (m.interests || []).join(', ');
    if (m.lat!=null) document.getElementById('loc_lat').value = m.lat;
    if (m.lng!=null) document.getElementById('loc_lng').value = m.lng;
  }
  async function loadMe(){ try{ const me = await api('/me'); fillMe(me); } catch{} }
  document.getElementById('btnMe').onclick = loadMe;
  document.getElementById('btnSaveProfile').onclick = async ()=>{
    pfMsg.textContent = '儲存中…';
    try{
      const body = {
        nickname: document.getElementById('pf_nickname').value,
        gender: document.getElementById('pf_gender').value,
        birthday: document.getElementById('pf_birthday').value,
        bio: document.getElementById('pf_bio').value,
        interests: document.getElementById('pf_interests').value,
        city: document.getElementById('pf_city').value
      };
      const r = await api('/me/profile', {method:'POST', body: JSON.stringify(body)});
      pfMsg.textContent = '已儲存！';
      fillMe(r.me);
    }catch(e){ pfMsg.textContent = `失敗：${e.message}`; }
  };

  // ===== 定位（自動 & 手動）
  const locMsg = document.getElementById('locMsg');
  function setLatLng(lat,lng){
    if (lat!=null) document.getElementById('loc_lat').value = lat;
    if (lng!=null) document.getElementById('loc_lng').value = lng;
  }
  async function reportLocation(lat,lng){
    try{ await api('/me/location', {method:'POST', body: JSON.stringify({lat,lng})}); locMsg.textContent='已回報'; }
    catch(e){ locMsg.textContent='回報失敗：'+e.message; }
  }
  async function autoLocate(reportNow=false){
    locMsg.textContent = '定位中…';
    if (!navigator.geolocation) { locMsg.textContent='瀏覽器不支援定位'; return; }
    navigator.geolocation.getCurrentPosition(async pos=>{
      const lat = +pos.coords.latitude.toFixed(6);
      const lng = +pos.coords.longitude.toFixed(6);
      setLatLng(lat,lng);
      locMsg.textContent = '已偵測';
      if (reportNow && getToken()) await reportLocation(lat,lng);
    }, _=>{ locMsg.textContent = '定位失敗'; });
  }
  document.getElementById('btnAutoLoc').onclick = ()=>autoLocate(false);
  document.getElementById('btnReportLoc').onclick = async ()=>{
    const lat = parseFloat(document.getElementById('loc_lat').value);
    const lng = parseFloat(document.getElementById('loc_lng').value);
    if (getToken()) await reportLocation(lat,lng);
  };
  // 2 分鐘自動回報
  setInterval(()=>{ if (!getToken()) return;
    navigator.geolocation && navigator.geolocation.getCurrentPosition(async pos=>{
      const lat = +pos.coords.latitude.toFixed(6);
      const lng = +pos.coords.longitude.toFixed(6);
      setLatLng(lat,lng); await reportLocation(lat,lng);
    }, _=>{});
  }, 120000);

  // ===== 附近
  const nbMsg = document.getElementById('nbMsg');
  const nearbyList = document.getElementById('nearbyList');
  function taglist(arr){ arr = arr||[]; return arr.map(t=>`<span class="pill">${t}</span>`).join(''); }
  function personCard(u){
    const nick = u.nickname || u.username;
    const gtxt = u.gender==='male'?'男':(u.gender==='female'?'女':'');
    const age = (u.age!=null? `・${u.age}歲` : '');
    const city = u.city ? `・${u.city}` : '';
    const dist = (u.distance_km!=null? `・${u.distance_km} km` : '');
    const bio = u.bio || '（尚未撰寫自我介紹）';
    return `
      <div class="card-sm">
        <div class="title">${nick}</div>
        <div class="muted">${gtxt}${age}${city}${dist}</div>
        <div style="margin:6px 0">${taglist(u.interests)}</div>
        <div class="muted" style="white-space:pre-wrap">${bio}</div>
      </div>`;
  }
  async function nearby(){
    nbMsg.textContent='搜尋中…'; nearbyList.innerHTML='';
    try{
      const body = {
        radius_km: parseFloat(document.getElementById('loc_radius').value || '100'),
        gender: document.getElementById('nb_gender').value || null,
        min_age: document.getElementById('nb_min').value ? +document.getElementById('nb_min').value : null,
        max_age: document.getElementById('nb_max').value ? +document.getElementById('nb_max').value : null,
        interest: document.getElementById('nb_interest').value || null
      };
      const r = await api('/nearby', {method:'POST', body: JSON.stringify(body)});
      nbMsg.textContent = `找到 ${r.total} 位`;
      nearbyList.innerHTML = r.users.map(personCard).join('');
    }catch(e){ nbMsg.textContent = `失敗：${e.message}`; }
  }
  document.getElementById('btnNearby').onclick = nearby;

  // ===== 我的配對（點卡片開 DM）
  const myMatchesEl = document.getElementById('myMatches');
  function matchCard(m){
    const nick = m.nickname || m.username;
    const g = m.gender==='male'?'男':(m.gender==='female'?'女':'');
    const age = (m.age!=null? `${m.age}歲` : '');
    const city = m.city || '';
    const bio = m.bio || '（尚未撰寫自我介紹）';
    const tags = (m.interests || []).map(t=>`<span class="pill">${t}</span>`).join('');
    return `
      <div class="card-sm" data-uid="${m.id}" style="cursor:pointer" onclick="openDM(${m.id})">
        <div class="title">${nick}</div>
        <div class="muted">${g}${age? '・'+age : ''}${city? '・'+city : ''}${m.distance_km!=null? '・'+m.distance_km+' km':''}</div>
        <div style="margin:6px 0">${tags}</div>
        <div class="muted" style="white-space:pre-wrap">${bio}</div>
      </div>`;
  }
  async function loadMyMatches(){
    try{
      const data = await api('/matches');
      const arr = data.matches || [];
      myMatchesEl.innerHTML = arr.length ? arr.map(matchCard).join('') : `<div class="muted">目前尚無配對</div>`;
    }catch(e){
      myMatchesEl.innerHTML = `<div class="muted">載入失敗：${e.message}</div>`;
    }
  }
  document.getElementById('btnReloadMatches').onclick = loadMyMatches;

  // ===== 聊天室（只能由 openDM 開啟）
  const roomListEl = document.getElementById('roomList');
  const chatBox = document.getElementById('chatBox');
  const chatHeader = document.getElementById('chatHeader');
  const chatInput = document.getElementById('chatInput');
  let currentRoomId = null, ws = null, userIdCache = null;

  async function cacheMeId(){ try{ const me = await api('/me'); userIdCache = me.id; } catch{} }

  function roomItem(r){
    const title = (r.members||[]).map(m=>m.nickname||m.username).join('、') || `#${r.room_id}`;
    const last = r.last_message ? r.last_message.content : '（尚無訊息）';
    // 只顯示，不提供點擊開啟
    return `<div class="card-sm"><div class="title">${title}</div><div class="muted">${last}</div></div>`;
  }
  async function loadMyChats(){
    try{ const rooms = await api('/chats/my'); roomListEl.innerHTML = rooms.map(roomItem).join(''); }
    catch(e){ roomListEl.innerHTML = `<div class="muted">${e.message}</div>`; }
  }
  document.getElementById('btnReloadRooms').onclick = loadMyChats;

  async function openDM(peerId){
    try{
      const res = await api('/chats/open_dm', {method:'POST', body: JSON.stringify({ peer_id: peerId })});
      await loadMyChats();
      openRoom(res.room_id);
    }catch(e){ alert('無法開啟聊天室：'+e.message); }
  }

  async function openRoom(roomId){
    if (ws){ try{ws.close()}catch{} ws = null; }
    currentRoomId = roomId;
    chatBox.innerHTML = '載入中…';
    const his = await api(`/chats/${roomId}/history`);
    chatBox.innerHTML = '';
    for (const m of his.messages) appendMsg(m, false);
    chatHeader.textContent = `房間 #${roomId}`;
    const proto = location.protocol === 'https:' ? 'wss' : 'ws';
    ws = new WebSocket(`${proto}://${location.host}/ws/chat/${roomId}?token=${encodeURIComponent(getToken())}`);
    ws.onmessage = e => { const data = JSON.parse(e.data); if (data.type === 'msg') appendMsg(data, true); };
  }

  function escapeHTML(s){ return (s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
  function appendMsg(m, scroll=true){
    const who = (m.sender_id === userIdCache ? '我' : `#${m.sender_id}`);
    const el = document.createElement('div');
    el.className = 'card-sm'; el.style.marginBottom = '6px';
    el.innerHTML = `<div class="muted">${who}・${(m.created_at||'').replace('T',' ').slice(0,19)}</div>
                    <div style="white-space:pre-wrap">${escapeHTML(m.content)}</div>`;
    chatBox.appendChild(el);
    if (scroll) chatBox.scrollTop = chatBox.scrollHeight;
  }

  document.getElementById('btnSendChat').onclick = sendChat;
  chatInput.addEventListener('keydown', e=>{ if (e.key==='Enter') sendChat(); });
  function sendChat(){
    const txt = chatInput.value.trim();
    if (!txt || !ws || ws.readyState!==1) return;
    ws.send(JSON.stringify({type:'msg', content: txt}));
    chatInput.value = '';
  }

  // ===== 初始：若已登入，載入資料
  if (getToken()){
    loadMe(); loadMyMatches(); cacheMeId(); loadMyChats(); autoLocate(true);
  }
</script>
</body>
</html>
