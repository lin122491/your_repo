<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>遊戲配對網</title>
  <style>
    body{font-family:system-ui,-apple-system,"Noto Sans TC","Segoe UI",Roboto,Arial;background:#f7f7fb;margin:0;color:#222}
    .wrap{max-width:1100px;margin:28px auto;padding:0 16px}
    h1{font-size:28px;margin:0 0 8px}
    .sub{color:#666;margin-bottom:16px}
    .card{background:#fff;border-radius:14px;box-shadow:0 6px 20px rgba(0,0,0,.08);padding:18px 20px;margin:14px 0}
    .row{display:flex;gap:16px;flex-wrap:wrap}
    .col{flex:1 1 420px;min-width:320px}
    label{display:block;font-size:14px;margin:8px 0 6px;color:#444}
    input,select,textarea{width:100%;box-sizing:border-box;border:1px solid #d7d7e0;border-radius:10px;padding:10px 12px;font-size:15px;outline:none}
    input:focus,textarea:focus{border-color:#5b8def;box-shadow:0 0 0 3px rgba(91,141,239,.15)}
    .btn{display:inline-block;border:0;border-radius:10px;padding:10px 16px;background:#2962ff;color:#fff;cursor:pointer;font-weight:600}
    .btn.green{background:#0aa56b}
    .btn.gray{background:#e5e7eb;color:#111}
    .status{font-weight:700;padding:5px 9px;border-radius:999px}
    .ok{background:#e6f7ef;color:#117a47}
    .bad{background:#fde8e8;color:#9b2226}
    .muted{color:#666;font-size:13px}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px}
    .tag{display:inline-block;background:#eef2ff;color:#1f3a8a;border-radius:999px;padding:2px 8px;margin:2px 4px 0 0;font-size:12px}
    .small{font-size:12px;color:#555}
  </style>
</head>
<body>
<div class="wrap">
  <h1>遊戲配對網</h1>
  <div class="sub">註冊需同意 <a href="/disclaimer" target="_blank">免責聲明</a> 與 <a href="/privacy" target="_blank">隱私權政策</a>。</div>

  <div class="row">
    <div class="card col">
      <h3>建立帳號</h3>
      <label>用戶名</label><input id="su_username" autocomplete="username">
      <label>密碼（≥6）</label><input id="su_password" type="password" autocomplete="new-password">
      <label>電子信箱（可空白）</label><input id="su_email" type="email">
      <label><input type="checkbox" id="su_consent"> 我已詳讀並同意 <a href="/disclaimer" target="_blank">免責聲明</a> 與 <a href="/privacy" target="_blank">隱私權政策</a></label>
      <div style="margin-top:10px"><button class="btn" id="btnSignup">註冊</button></div>
      <div class="muted" id="su_msg" style="margin-top:8px"></div>
    </div>

    <div class="card col">
      <h3>登入</h3>
      <label>用戶名</label><input id="li_username" autocomplete="username">
      <label>密碼</label><input id="li_password" type="password" autocomplete="current-password">
      <div style="margin-top:10px"><button class="btn green" id="btnLogin">登入</button></div>
      <div class="muted" id="li_msg" style="margin-top:8px">登入成功後將自動回報定位。</div>
      <div style="margin-top:8px">登入狀態：<span id="authStatus" class="status bad">未登入</span> <button class="btn gray" id="btnLogout">登出</button></div>
    </div>
  </div>

  <div class="card">
    <h3>我的資料</h3>
    <div class="row">
      <div class="col">
        <label>暱稱</label><input id="pf_name">
      </div>
      <div class="col">
        <label>性別</label>
        <select id="pf_gender">
          <option value="">（未設定）</option>
          <option value="男">男</option>
          <option value="女">女</option>
          <option value="其他">其他</option>
        </select>
      </div>
      <div class="col">
        <label>生日</label><input id="pf_bday" type="date">
      </div>
      <div class="col">
        <label>城市</label><input id="pf_city" placeholder="例：台北市">
      </div>
    </div>
    <label>自我介紹</label><textarea id="pf_bio" rows="3"></textarea>
    <label>興趣標籤（以逗號分隔；英數自動大寫、中文維持原樣）</label>
    <input id="pf_interests" placeholder="例如：LOL, 漫畫, APEX">
    <div style="margin-top:10px;display:flex;gap:8px">
      <button class="btn" id="btnSaveProfile">儲存</button>
      <button class="btn gray" id="btnRefreshMe">重新載入</button>
    </div>
    <div class="muted" id="me_msg" style="margin-top:8px"></div>
  </div>

  <div class="row">
    <div class="card col">
      <h3>附近的人（預設 100 公里）</h3>
      <div class="small">已嘗試自動回報定位；若未授權定位，請到瀏覽器允許或手動變更城市。</div>
      <div style="margin:10px 0">
        <label>搜尋半徑（公里）</label>
        <input id="radius" value="100">
        <button class="btn" id="btnNearby">搜尋附近</button>
      </div>
      <div id="nearbyList" class="grid"></div>
    </div>

    <div class="card col">
      <h3>快速連結</h3>
      <div><a href="/disclaimer" target="_blank">免責聲明</a> ｜ <a href="/privacy" target="_blank">隱私權政策</a> ｜ <a href="/docs" target="_blank">API文件</a></div>
    </div>
  </div>
</div>

<script>
  // ------------ API base：隱藏，預設用同源 ------------
  const API_BASE = window.location.origin;

  // ------------ Auth Token ------------
  const tokenKey = 'authToken';
  const setToken = t => { localStorage.setItem(tokenKey, t); refreshAuthStatus(); };
  const getToken = () => localStorage.getItem(tokenKey) || '';
  const clearToken = () => { localStorage.removeItem(tokenKey); refreshAuthStatus(); };
  const authHeader = () => getToken() ? { 'Authorization': `Bearer ${getToken()}` } : {};

  function refreshAuthStatus(){
    const el = document.getElementById('authStatus');
    if(getToken()){
      el.textContent = '已登入'; el.className = 'status ok';
    }else{
      el.textContent = '未登入'; el.className = 'status bad';
    }
  }
  refreshAuthStatus();

  // ------------ 註冊 / 登入 / 登出 ------------
  document.getElementById('btnSignup').onclick = async () => {
    const username = document.getElementById('su_username').value.trim();
    const password = document.getElementById('su_password').value;
    const email = document.getElementById('su_email').value.trim();
    const consent = document.getElementById('su_consent').checked;
    const msg = document.getElementById('su_msg');
    msg.textContent = '送出中…';
    try{
      const r = await fetch(`${API_BASE}/auth/signup`, {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({username, password, email, consent_agreed: consent})
      });
      const data = await r.json();
      if(!r.ok) throw new Error(data.detail || r.statusText);
      msg.textContent = '註冊成功，請登入。';
    }catch(e){ msg.textContent = `失敗：${e.message || e}`; }
  };

  document.getElementById('btnLogin').onclick = async () => {
    const username = document.getElementById('li_username').value.trim();
    const password = document.getElementById('li_password').value;
    const el = document.getElementById('li_msg');
    el.textContent = '登入中…';
    try{
      const r = await fetch(`${API_BASE}/auth/login`, {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({username, password})
      });
      const data = await r.json();
      if(!r.ok) throw new Error(data.detail || r.statusText);
      setToken(data.access_token);
      el.textContent = '登入成功！將嘗試自動回報定位…';
      // 自動回報定位
      tryAutoGeoReport();
    }catch(e){ el.textContent = `登入失敗：${e.message || e}`; }
  };

  document.getElementById('btnLogout').onclick = () => { clearToken(); };

  // ------------ 我 / 儲存 ------------
  async function loadMe(){
    const msg = document.getElementById('me_msg');
    msg.textContent = '載入中…';
    try{
      const r = await fetch(`${API_BASE}/me`, { headers: {...authHeader()} });
      const data = await r.json();
      if(!r.ok) throw new Error(data.detail || r.statusText);

      document.getElementById('pf_name').value = data.display_name || '';
      document.getElementById('pf_gender').value = data.gender || '';
      document.getElementById('pf_bday').value = data.birthday || '';
      document.getElementById('pf_city').value = data.city || '';
      document.getElementById('pf_bio').value = data.bio || '';
      document.getElementById('pf_interests').value = (data.interests||[]).join(', ');
      msg.textContent = '已載入。';
    }catch(e){ msg.textContent = `錯誤：${e.message || e}`; }
  }
  document.getElementById('btnRefreshMe').onclick = loadMe;

  document.getElementById('btnSaveProfile').onclick = async () => {
    const msg = document.getElementById('me_msg');
    msg.textContent = '儲存中…';
    const payload = {
      display_name: document.getElementById('pf_name').value.trim(),
      gender: document.getElementById('pf_gender').value,
      birthday: document.getElementById('pf_bday').value || null,
      city: document.getElementById('pf_city').value.trim(),
      bio: document.getElementById('pf_bio').value.trim(),
      interests: document.getElementById('pf_interests').value
        .split(',').map(s => s.trim()).filter(Boolean)
    };
    try{
      const r = await fetch(`${API_BASE}/me`, {
        method:'PATCH', headers:{'Content-Type':'application/json', ...authHeader()},
        body: JSON.stringify(payload)
      });
      const data = await r.json();
      if(!r.ok) throw new Error(data.detail || r.statusText);
      msg.textContent = '已儲存。';
    }catch(e){ msg.textContent = `錯誤：${e.message || e}`; }
  };

  // ------------ 定位 / 附近 ------------
  async function tryAutoGeoReport(){
    if(!getToken()) return;
    if(!navigator.geolocation) return;
    navigator.geolocation.getCurrentPosition(async (pos)=>{
      try{
        await fetch(`${API_BASE}/me/location`, {
          method:'POST', headers:{'Content-Type':'application/json', ...authHeader()},
          body: JSON.stringify({lat: pos.coords.latitude, lng: pos.coords.longitude})
        });
      }catch(_){}
    }, (_err)=>{/* 靜默 */}, {enableHighAccuracy:false, timeout:5000, maximumAge:60000});
  }

  async function searchNearby(){
    const list = document.getElementById('nearbyList');
    list.innerHTML = '搜尋中…';
    // 若沒有 Token 就不用查
    if(!getToken()){ list.innerHTML = '<div class="muted">請先登入</div>'; return; }

    // 取座標：優先用最近回報的；若無，嘗試抓一次
    let lat=null, lng=null;
    try{
      const me = await (await fetch(`${API_BASE}/me`, { headers:{...authHeader()} })).json();
      lat = me.lat; lng = me.lng;
      if((lat==null || lng==null) && navigator.geolocation){
        await new Promise(resolve=>{
          navigator.geolocation.getCurrentPosition((pos)=>{ lat=pos.coords.latitude; lng=pos.coords.longitude; resolve(); }, ()=>resolve(), {timeout:4000});
        });
      }
    }catch(_){}

    if(lat==null || lng==null){
      list.innerHTML = '<div class="muted">尚無定位，請允許定位或於個人資料填寫城市。</div>'; return;
    }

    const radius = parseFloat(document.getElementById('radius').value || '100');
    try{
      const r = await fetch(`${API_BASE}/nearby`, {
        method:'POST', headers:{'Content-Type':'application/json', ...authHeader()},
        body: JSON.stringify({lat, lng, radius_km: radius})
      });
      const data = await r.json();
      if(!r.ok) throw new Error(data.detail || r.statusText);
      renderNearby(data.users || []);
    }catch(e){ list.innerHTML = `<div class="muted">錯誤：${e.message || e}</div>`; }
  }
  document.getElementById('btnNearby').onclick = searchNearby;

  function renderNearby(users){
    const list = document.getElementById('nearbyList');
    if(!users.length){ list.innerHTML = '<div class="muted">目前查無附近用戶</div>'; return; }
    list.innerHTML = '';
    for(const u of users){
      const age = u.birthday ? calcAge(u.birthday) : '';
      const g = zhGender(u.gender);
      const tags = (u.interests||[]).map(t=>`<span class="tag">${escapeHtml(t)}</span>`).join(' ');
      const bio = u.bio ? escapeHtml(u.bio) : '（尚無自我介紹）';
      const card = document.createElement('div');
      card.className = 'card';
      card.innerHTML = `
        <div style="font-weight:700">${escapeHtml(u.display_name || u.username)}</div>
        <div class="small">${[g, age?`${age} 歲`:null, u.city||null].filter(Boolean).join("・")}　距離：約 ${u.distance_km} km</div>
        <div style="margin-top:6px">${bio}</div>
        <div style="margin-top:6px">${tags}</div>
      `;
      list.appendChild(card);
    }
  }

  const zhGender = g => {
    if(!g) return '未設定';
    const s = String(g).toLowerCase();
    if(s==='male' || s==='m' || s==='男') return '男';
    if(s==='female' || s==='f' || s==='女') return '女';
    return '其他';
  };

  const calcAge = iso => {
    try{
      const d = new Date(iso);
      const today = new Date();
      let age = today.getFullYear() - d.getFullYear();
      const m = today.getMonth() - d.getMonth();
      if (m < 0 || (m === 0 && today.getDate() < d.getDate())) age--;
      return age;
    }catch(_){ return ''; }
  };

  const escapeHtml = s => s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));

  // 初次載入
  refreshAuthStatus();
  if(getToken()){
    loadMe();
    tryAutoGeoReport();
  }
</script>
</body>
</html>
